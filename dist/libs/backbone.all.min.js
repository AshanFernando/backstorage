/*! backstorage 07-02-2015 */
!function(a,b){if("function"==typeof define&&define.amd)define(["underscore","jquery","exports"],function(c,d,e){a.Backbone=b(a,e,c,d)});else if("undefined"!=typeof exports){var c=require("underscore");b(a,exports,c)}else a.Backbone=b(a,{},a._,a.jQuery||a.Zepto||a.ender||a.$)}(this,function(a,b,c,d){{var e=a.Backbone,f=[],g=(f.push,f.slice);f.splice}b.VERSION="1.1.2",b.$=d,b.noConflict=function(){return a.Backbone=e,this},b.emulateHTTP=!1,b.emulateJSON=!1;var h=b.Events={on:function(a,b,c){if(!j(this,"on",a,[b,c])||!b)return this;this._events||(this._events={});var d=this._events[a]||(this._events[a]=[]);return d.push({callback:b,context:c,ctx:c||this}),this},once:function(a,b,d){if(!j(this,"once",a,[b,d])||!b)return this;var e=this,f=c.once(function(){e.off(a,f),b.apply(this,arguments)});return f._callback=b,this.on(a,f,d)},off:function(a,b,d){var e,f,g,h,i,k,l,m;if(!this._events||!j(this,"off",a,[b,d]))return this;if(!a&&!b&&!d)return this._events=void 0,this;for(h=a?[a]:c.keys(this._events),i=0,k=h.length;k>i;i++)if(a=h[i],g=this._events[a]){if(this._events[a]=e=[],b||d)for(l=0,m=g.length;m>l;l++)f=g[l],(b&&b!==f.callback&&b!==f.callback._callback||d&&d!==f.context)&&e.push(f);e.length||delete this._events[a]}return this},trigger:function(a){if(!this._events)return this;var b=g.call(arguments,1);if(!j(this,"trigger",a,b))return this;var c=this._events[a],d=this._events.all;return c&&k(c,b),d&&k(d,arguments),this},stopListening:function(a,b,d){var e=this._listeningTo;if(!e)return this;var f=!b&&!d;d||"object"!=typeof b||(d=this),a&&((e={})[a._listenId]=a);for(var g in e)a=e[g],a.off(b,d,this),(f||c.isEmpty(a._events))&&delete this._listeningTo[g];return this}},i=/\s+/,j=function(a,b,c,d){if(!c)return!0;if("object"==typeof c){for(var e in c)a[b].apply(a,[e,c[e]].concat(d));return!1}if(i.test(c)){for(var f=c.split(i),g=0,h=f.length;h>g;g++)a[b].apply(a,[f[g]].concat(d));return!1}return!0},k=function(a,b){var c,d=-1,e=a.length,f=b[0],g=b[1],h=b[2];switch(b.length){case 0:for(;++d<e;)(c=a[d]).callback.call(c.ctx);return;case 1:for(;++d<e;)(c=a[d]).callback.call(c.ctx,f);return;case 2:for(;++d<e;)(c=a[d]).callback.call(c.ctx,f,g);return;case 3:for(;++d<e;)(c=a[d]).callback.call(c.ctx,f,g,h);return;default:for(;++d<e;)(c=a[d]).callback.apply(c.ctx,b);return}},l={listenTo:"on",listenToOnce:"once"};c.each(l,function(a,b){h[b]=function(b,d,e){var f=this._listeningTo||(this._listeningTo={}),g=b._listenId||(b._listenId=c.uniqueId("l"));return f[g]=b,e||"object"!=typeof d||(e=this),b[a](d,e,this),this}}),h.bind=h.on,h.unbind=h.off,c.extend(b,h);var m=b.Model=function(a,b){var d=a||{};b||(b={}),this.cid=c.uniqueId("c"),this.attributes={},b.collection&&(this.collection=b.collection),b.parse&&(d=this.parse(d,b)||{}),d=c.defaults({},d,c.result(this,"defaults")),this.set(d,b),this.changed={},this.initialize.apply(this,arguments)};c.extend(m.prototype,h,{changed:null,validationError:null,idAttribute:"id",initialize:function(){},toJSON:function(){return c.clone(this.attributes)},sync:function(){return b.sync.apply(this,arguments)},get:function(a){return this.attributes[a]},escape:function(a){return c.escape(this.get(a))},has:function(a){return null!=this.get(a)},set:function(a,b,d){var e,f,g,h,i,j,k,l;if(null==a)return this;if("object"==typeof a?(f=a,d=b):(f={})[a]=b,d||(d={}),!this._validate(f,d))return!1;g=d.unset,i=d.silent,h=[],j=this._changing,this._changing=!0,j||(this._previousAttributes=c.clone(this.attributes),this.changed={}),l=this.attributes,k=this._previousAttributes,this.idAttribute in f&&(this.id=f[this.idAttribute]);for(e in f)b=f[e],c.isEqual(l[e],b)||h.push(e),c.isEqual(k[e],b)?delete this.changed[e]:this.changed[e]=b,g?delete l[e]:l[e]=b;if(!i){h.length&&(this._pending=d);for(var m=0,n=h.length;n>m;m++)this.trigger("change:"+h[m],this,l[h[m]],d)}if(j)return this;if(!i)for(;this._pending;)d=this._pending,this._pending=!1,this.trigger("change",this,d);return this._pending=!1,this._changing=!1,this},unset:function(a,b){return this.set(a,void 0,c.extend({},b,{unset:!0}))},clear:function(a){var b={};for(var d in this.attributes)b[d]=void 0;return this.set(b,c.extend({},a,{unset:!0}))},hasChanged:function(a){return null==a?!c.isEmpty(this.changed):c.has(this.changed,a)},changedAttributes:function(a){if(!a)return this.hasChanged()?c.clone(this.changed):!1;var b,d=!1,e=this._changing?this._previousAttributes:this.attributes;for(var f in a)c.isEqual(e[f],b=a[f])||((d||(d={}))[f]=b);return d},previous:function(a){return null!=a&&this._previousAttributes?this._previousAttributes[a]:null},previousAttributes:function(){return c.clone(this._previousAttributes)},fetch:function(a){a=a?c.clone(a):{},void 0===a.parse&&(a.parse=!0);var b=this,d=a.success;return a.success=function(c){return b.set(b.parse(c,a),a)?(d&&d(b,c,a),void b.trigger("sync",b,c,a)):!1},L(this,a),this.sync("read",this,a)},save:function(a,b,d){var e,f,g,h=this.attributes;if(null==a||"object"==typeof a?(e=a,d=b):(e={})[a]=b,d=c.extend({validate:!0},d),e&&!d.wait){if(!this.set(e,d))return!1}else if(!this._validate(e,d))return!1;e&&d.wait&&(this.attributes=c.extend({},h,e)),void 0===d.parse&&(d.parse=!0);var i=this,j=d.success;return d.success=function(a){i.attributes=h;var b=i.parse(a,d);return d.wait&&(b=c.extend(e||{},b)),c.isObject(b)&&!i.set(b,d)?!1:(j&&j(i,a,d),void i.trigger("sync",i,a,d))},L(this,d),f=this.isNew()?"create":d.patch?"patch":"update","patch"===f&&(d.attrs=e),g=this.sync(f,this,d),e&&d.wait&&(this.attributes=h),g},destroy:function(a){a=a?c.clone(a):{};var b=this,d=a.success,e=function(){b.trigger("destroy",b,b.collection,a)};if(a.success=function(c){(a.wait||b.isNew())&&e(),d&&d(b,c,a),b.isNew()||b.trigger("sync",b,c,a)},this.isNew())return a.success(),!1;L(this,a);var f=this.sync("delete",this,a);return a.wait||e(),f},url:function(){var a=c.result(this,"urlRoot")||c.result(this.collection,"url")||K();return this.isNew()?a:a.replace(/([^\/])$/,"$1/")+encodeURIComponent(this.id)},parse:function(a){return a},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return!this.has(this.idAttribute)},isValid:function(a){return this._validate({},c.extend(a||{},{validate:!0}))},_validate:function(a,b){if(!b.validate||!this.validate)return!0;a=c.extend({},this.attributes,a);var d=this.validationError=this.validate(a,b)||null;return d?(this.trigger("invalid",this,d,c.extend(b,{validationError:d})),!1):!0}});var n=["keys","values","pairs","invert","pick","omit"];c.each(n,function(a){m.prototype[a]=function(){var b=g.call(arguments);return b.unshift(this.attributes),c[a].apply(c,b)}});var o=b.Collection=function(a,b){b||(b={}),b.model&&(this.model=b.model),void 0!==b.comparator&&(this.comparator=b.comparator),this._reset(),this.initialize.apply(this,arguments),a&&this.reset(a,c.extend({silent:!0},b))},p={add:!0,remove:!0,merge:!0},q={add:!0,remove:!1};c.extend(o.prototype,h,{model:m,initialize:function(){},toJSON:function(a){return this.map(function(b){return b.toJSON(a)})},sync:function(){return b.sync.apply(this,arguments)},add:function(a,b){return this.set(a,c.extend({merge:!1},b,q))},remove:function(a,b){var d=!c.isArray(a);a=d?[a]:c.clone(a),b||(b={});var e,f,g,h;for(e=0,f=a.length;f>e;e++)h=a[e]=this.get(a[e]),h&&(delete this._byId[h.id],delete this._byId[h.cid],g=this.indexOf(h),this.models.splice(g,1),this.length--,b.silent||(b.index=g,h.trigger("remove",h,this,b)),this._removeReference(h,b));return d?a[0]:a},set:function(a,b){b=c.defaults({},b,p),b.parse&&(a=this.parse(a,b));var d=!c.isArray(a);a=d?a?[a]:[]:c.clone(a);var e,f,g,h,i,j,k,l=b.at,n=this.model,o=this.comparator&&null==l&&b.sort!==!1,q=c.isString(this.comparator)?this.comparator:null,r=[],s=[],t={},u=b.add,v=b.merge,w=b.remove,x=!o&&u&&w?[]:!1;for(e=0,f=a.length;f>e;e++){if(i=a[e]||{},g=i instanceof m?h=i:i[n.prototype.idAttribute||"id"],j=this.get(g))w&&(t[j.cid]=!0),v&&(i=i===h?h.attributes:i,b.parse&&(i=j.parse(i,b)),j.set(i,b),o&&!k&&j.hasChanged(q)&&(k=!0)),a[e]=j;else if(u){if(h=a[e]=this._prepareModel(i,b),!h)continue;r.push(h),this._addReference(h,b)}h=j||h,!x||!h.isNew()&&t[h.id]||x.push(h),t[h.id]=!0}if(w){for(e=0,f=this.length;f>e;++e)t[(h=this.models[e]).cid]||s.push(h);s.length&&this.remove(s,b)}if(r.length||x&&x.length)if(o&&(k=!0),this.length+=r.length,null!=l)for(e=0,f=r.length;f>e;e++)this.models.splice(l+e,0,r[e]);else{x&&(this.models.length=0);var y=x||r;for(e=0,f=y.length;f>e;e++)this.models.push(y[e])}if(k&&this.sort({silent:!0}),!b.silent){for(e=0,f=r.length;f>e;e++)(h=r[e]).trigger("add",h,this,b);(k||x&&x.length)&&this.trigger("sort",this,b)}return d?a[0]:a},reset:function(a,b){b||(b={});for(var d=0,e=this.models.length;e>d;d++)this._removeReference(this.models[d],b);return b.previousModels=this.models,this._reset(),a=this.add(a,c.extend({silent:!0},b)),b.silent||this.trigger("reset",this,b),a},push:function(a,b){return this.add(a,c.extend({at:this.length},b))},pop:function(a){var b=this.at(this.length-1);return this.remove(b,a),b},unshift:function(a,b){return this.add(a,c.extend({at:0},b))},shift:function(a){var b=this.at(0);return this.remove(b,a),b},slice:function(){return g.apply(this.models,arguments)},get:function(a){return null==a?void 0:this._byId[a]||this._byId[a.id]||this._byId[a.cid]},at:function(a){return this.models[a]},where:function(a,b){return c.isEmpty(a)?b?void 0:[]:this[b?"find":"filter"](function(b){for(var c in a)if(a[c]!==b.get(c))return!1;return!0})},findWhere:function(a){return this.where(a,!0)},sort:function(a){if(!this.comparator)throw new Error("Cannot sort a set without a comparator");return a||(a={}),c.isString(this.comparator)||1===this.comparator.length?this.models=this.sortBy(this.comparator,this):this.models.sort(c.bind(this.comparator,this)),a.silent||this.trigger("sort",this,a),this},pluck:function(a){return c.invoke(this.models,"get",a)},fetch:function(a){a=a?c.clone(a):{},void 0===a.parse&&(a.parse=!0);var b=a.success,d=this;return a.success=function(c){var e=a.reset?"reset":"set";d[e](c,a),b&&b(d,c,a),d.trigger("sync",d,c,a)},L(this,a),this.sync("read",this,a)},create:function(a,b){if(b=b?c.clone(b):{},!(a=this._prepareModel(a,b)))return!1;b.wait||this.add(a,b);var d=this,e=b.success;return b.success=function(a,c){b.wait&&d.add(a,b),e&&e(a,c,b)},a.save(null,b),a},parse:function(a){return a},clone:function(){return new this.constructor(this.models)},_reset:function(){this.length=0,this.models=[],this._byId={}},_prepareModel:function(a,b){if(a instanceof m)return a;b=b?c.clone(b):{},b.collection=this;var d=new this.model(a,b);return d.validationError?(this.trigger("invalid",this,d.validationError,b),!1):d},_addReference:function(a){this._byId[a.cid]=a,null!=a.id&&(this._byId[a.id]=a),a.collection||(a.collection=this),a.on("all",this._onModelEvent,this)},_removeReference:function(a){this===a.collection&&delete a.collection,a.off("all",this._onModelEvent,this)},_onModelEvent:function(a,b,c,d){("add"!==a&&"remove"!==a||c===this)&&("destroy"===a&&this.remove(b,d),b&&a==="change:"+b.idAttribute&&(delete this._byId[b.previous(b.idAttribute)],null!=b.id&&(this._byId[b.id]=b)),this.trigger.apply(this,arguments))}});var r=["forEach","each","map","collect","reduce","foldl","inject","reduceRight","foldr","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","toArray","size","first","head","take","initial","rest","tail","drop","last","without","difference","indexOf","shuffle","lastIndexOf","isEmpty","chain","sample"];c.each(r,function(a){o.prototype[a]=function(){var b=g.call(arguments);return b.unshift(this.models),c[a].apply(c,b)}});var s=["groupBy","countBy","sortBy","indexBy"];c.each(s,function(a){o.prototype[a]=function(b,d){var e=c.isFunction(b)?b:function(a){return a.get(b)};return c[a](this.models,e,d)}});var t=b.View=function(a){this.cid=c.uniqueId("view"),a||(a={}),c.extend(this,c.pick(a,v)),this._ensureElement(),this.initialize.apply(this,arguments),this.delegateEvents()},u=/^(\S+)\s*(.*)$/,v=["model","collection","el","id","attributes","className","tagName","events"];c.extend(t.prototype,h,{tagName:"div",$:function(a){return this.$el.find(a)},initialize:function(){},render:function(){return this},remove:function(){return this.$el.remove(),this.stopListening(),this},setElement:function(a,c){return this.$el&&this.undelegateEvents(),this.$el=a instanceof b.$?a:b.$(a),this.el=this.$el[0],c!==!1&&this.delegateEvents(),this},delegateEvents:function(a){if(!a&&!(a=c.result(this,"events")))return this;this.undelegateEvents();for(var b in a){var d=a[b];if(c.isFunction(d)||(d=this[a[b]]),d){var e=b.match(u),f=e[1],g=e[2];d=c.bind(d,this),f+=".delegateEvents"+this.cid,""===g?this.$el.on(f,d):this.$el.on(f,g,d)}}return this},undelegateEvents:function(){return this.$el.off(".delegateEvents"+this.cid),this},_ensureElement:function(){if(this.el)this.setElement(c.result(this,"el"),!1);else{var a=c.extend({},c.result(this,"attributes"));this.id&&(a.id=c.result(this,"id")),this.className&&(a["class"]=c.result(this,"className"));var d=b.$("<"+c.result(this,"tagName")+">").attr(a);this.setElement(d,!1)}}}),b.sync=function(a,d,e){var f=x[a];c.defaults(e||(e={}),{emulateHTTP:b.emulateHTTP,emulateJSON:b.emulateJSON});var g={type:f,dataType:"json"};if(e.url||(g.url=c.result(d,"url")||K()),null!=e.data||!d||"create"!==a&&"update"!==a&&"patch"!==a||(g.contentType="application/json",g.data=JSON.stringify(e.attrs||d.toJSON(e))),e.emulateJSON&&(g.contentType="application/x-www-form-urlencoded",g.data=g.data?{model:g.data}:{}),e.emulateHTTP&&("PUT"===f||"DELETE"===f||"PATCH"===f)){g.type="POST",e.emulateJSON&&(g.data._method=f);var h=e.beforeSend;e.beforeSend=function(a){return a.setRequestHeader("X-HTTP-Method-Override",f),h?h.apply(this,arguments):void 0}}"GET"===g.type||e.emulateJSON||(g.processData=!1),"PATCH"===g.type&&w&&(g.xhr=function(){return new ActiveXObject("Microsoft.XMLHTTP")});var i=e.xhr=b.ajax(c.extend(g,e));return d.trigger("request",d,i,e),i};var w=!("undefined"==typeof window||!window.ActiveXObject||window.XMLHttpRequest&&(new XMLHttpRequest).dispatchEvent),x={create:"POST",update:"PUT",patch:"PATCH","delete":"DELETE",read:"GET"};b.ajax=function(){return b.$.ajax.apply(b.$,arguments)};var y=b.Router=function(a){a||(a={}),a.routes&&(this.routes=a.routes),this._bindRoutes(),this.initialize.apply(this,arguments)},z=/\((.*?)\)/g,A=/(\(\?)?:\w+/g,B=/\*\w+/g,C=/[\-{}\[\]+?.,\\\^$|#\s]/g;c.extend(y.prototype,h,{initialize:function(){},route:function(a,d,e){c.isRegExp(a)||(a=this._routeToRegExp(a)),c.isFunction(d)&&(e=d,d=""),e||(e=this[d]);var f=this;return b.history.route(a,function(c){var g=f._extractParameters(a,c);f.execute(e,g),f.trigger.apply(f,["route:"+d].concat(g)),f.trigger("route",d,g),b.history.trigger("route",f,d,g)}),this},execute:function(a,b){a&&a.apply(this,b)},navigate:function(a,c){return b.history.navigate(a,c),this},_bindRoutes:function(){if(this.routes){this.routes=c.result(this,"routes");for(var a,b=c.keys(this.routes);null!=(a=b.pop());)this.route(a,this.routes[a])}},_routeToRegExp:function(a){return a=a.replace(C,"\\$&").replace(z,"(?:$1)?").replace(A,function(a,b){return b?a:"([^/?]+)"}).replace(B,"([^?]*?)"),new RegExp("^"+a+"(?:\\?([\\s\\S]*))?$")},_extractParameters:function(a,b){var d=a.exec(b).slice(1);return c.map(d,function(a,b){return b===d.length-1?a||null:a?decodeURIComponent(a):null})}});var D=b.History=function(){this.handlers=[],c.bindAll(this,"checkUrl"),"undefined"!=typeof window&&(this.location=window.location,this.history=window.history)},E=/^[#\/]|\s+$/g,F=/^\/+|\/+$/g,G=/msie [\w.]+/,H=/\/$/,I=/#.*$/;D.started=!1,c.extend(D.prototype,h,{interval:50,atRoot:function(){return this.location.pathname.replace(/[^\/]$/,"$&/")===this.root},getHash:function(a){var b=(a||this).location.href.match(/#(.*)$/);return b?b[1]:""},getFragment:function(a,b){if(null==a)if(this._hasPushState||!this._wantsHashChange||b){a=decodeURI(this.location.pathname+this.location.search);var c=this.root.replace(H,"");a.indexOf(c)||(a=a.slice(c.length))}else a=this.getHash();return a.replace(E,"")},start:function(a){if(D.started)throw new Error("Backbone.history has already been started");D.started=!0,this.options=c.extend({root:"/"},this.options,a),this.root=this.options.root,this._wantsHashChange=this.options.hashChange!==!1,this._wantsPushState=!!this.options.pushState,this._hasPushState=!!(this.options.pushState&&this.history&&this.history.pushState);var d=this.getFragment(),e=document.documentMode,f=G.exec(navigator.userAgent.toLowerCase())&&(!e||7>=e);if(this.root=("/"+this.root+"/").replace(F,"/"),f&&this._wantsHashChange){var g=b.$('<iframe src="javascript:0" tabindex="-1">');this.iframe=g.hide().appendTo("body")[0].contentWindow,this.navigate(d)}this._hasPushState?b.$(window).on("popstate",this.checkUrl):this._wantsHashChange&&"onhashchange"in window&&!f?b.$(window).on("hashchange",this.checkUrl):this._wantsHashChange&&(this._checkUrlInterval=setInterval(this.checkUrl,this.interval)),this.fragment=d;var h=this.location;if(this._wantsHashChange&&this._wantsPushState){if(!this._hasPushState&&!this.atRoot())return this.fragment=this.getFragment(null,!0),this.location.replace(this.root+"#"+this.fragment),!0;this._hasPushState&&this.atRoot()&&h.hash&&(this.fragment=this.getHash().replace(E,""),this.history.replaceState({},document.title,this.root+this.fragment))}return this.options.silent?void 0:this.loadUrl()},stop:function(){b.$(window).off("popstate",this.checkUrl).off("hashchange",this.checkUrl),this._checkUrlInterval&&clearInterval(this._checkUrlInterval),D.started=!1},route:function(a,b){this.handlers.unshift({route:a,callback:b})},checkUrl:function(){var a=this.getFragment();return a===this.fragment&&this.iframe&&(a=this.getFragment(this.getHash(this.iframe))),a===this.fragment?!1:(this.iframe&&this.navigate(a),void this.loadUrl())},loadUrl:function(a){return a=this.fragment=this.getFragment(a),c.any(this.handlers,function(b){return b.route.test(a)?(b.callback(a),!0):void 0})},navigate:function(a,b){if(!D.started)return!1;b&&b!==!0||(b={trigger:!!b});var c=this.root+(a=this.getFragment(a||""));if(a=a.replace(I,""),this.fragment!==a){if(this.fragment=a,""===a&&"/"!==c&&(c=c.slice(0,-1)),this._hasPushState)this.history[b.replace?"replaceState":"pushState"]({},document.title,c);else{if(!this._wantsHashChange)return this.location.assign(c);this._updateHash(this.location,a,b.replace),this.iframe&&a!==this.getFragment(this.getHash(this.iframe))&&(b.replace||this.iframe.document.open().close(),this._updateHash(this.iframe.location,a,b.replace))}return b.trigger?this.loadUrl(a):void 0}},_updateHash:function(a,b,c){if(c){var d=a.href.replace(/(javascript:|#).*$/,"");a.replace(d+"#"+b)}else a.hash="#"+b}}),b.history=new D;var J=function(a,b){var d,e=this;d=a&&c.has(a,"constructor")?a.constructor:function(){return e.apply(this,arguments)},c.extend(d,e,b);var f=function(){this.constructor=d};return f.prototype=e.prototype,d.prototype=new f,a&&c.extend(d.prototype,a),d.__super__=e.prototype,d};m.extend=o.extend=y.extend=t.extend=D.extend=J;var K=function(){throw new Error('A "url" property or function must be specified')},L=function(a,b){var c=b.error;b.error=function(d){c&&c(a,d,b),a.trigger("error",a,d,b)}};return b}),function(a,b){"function"==typeof define&&define.amd?define(["exports","backbone","underscore"],b):"undefined"!=typeof exports?b(exports,require("backbone"),require("underscore")):b(a,a.Backbone,a._)}(this,function(a,b,c){"use strict";b.Relational={showWarnings:!0},b.Semaphore={_permitsAvailable:null,_permitsUsed:0,acquire:function(){if(this._permitsAvailable&&this._permitsUsed>=this._permitsAvailable)throw new Error("Max permits acquired");this._permitsUsed++},release:function(){if(0===this._permitsUsed)throw new Error("All permits released");this._permitsUsed--},isLocked:function(){return this._permitsUsed>0},setAvailablePermits:function(a){if(this._permitsUsed>a)throw new Error("Available permits cannot be less than used permits");this._permitsAvailable=a}},b.BlockingQueue=function(){this._queue=[]},c.extend(b.BlockingQueue.prototype,b.Semaphore,{_queue:null,add:function(a){this.isBlocked()?this._queue.push(a):a()},process:function(){var a=this._queue;for(this._queue=[];a&&a.length;)a.shift()()},block:function(){this.acquire()},unblock:function(){this.release(),this.isBlocked()||this.process()},isBlocked:function(){return this.isLocked()}}),b.Relational.eventQueue=new b.BlockingQueue,b.Store=function(){this._collections=[],this._reverseRelations=[],this._orphanRelations=[],this._subModels=[],this._modelScopes=[a]},c.extend(b.Store.prototype,b.Events,{initializeRelation:function(a,d,e){var f=c.isString(d.type)?b[d.type]||this.getObjectByName(d.type):d.type;if(f&&f.prototype instanceof b.Relation){new f(a,d,e)}else b.Relational.showWarnings&&"undefined"!=typeof console&&console.warn("Relation=%o; missing or invalid relation type!",d)},addModelScope:function(a){this._modelScopes.push(a)},removeModelScope:function(a){this._modelScopes=c.without(this._modelScopes,a)},addSubModels:function(a,b){this._subModels.push({superModelType:b,subModels:a})},setupSuperModel:function(a){c.find(this._subModels,function(b){return c.filter(b.subModels||[],function(c,d){var e=this.getObjectByName(c);return a===e?(b.superModelType._subModels[d]=a,a._superModel=b.superModelType,a._subModelTypeValue=d,a._subModelTypeAttribute=b.superModelType.prototype.subModelTypeAttribute,!0):void 0},this).length},this)},addReverseRelation:function(a){var b=c.any(this._reverseRelations,function(b){return c.all(a||[],function(a,c){return a===b[c]})});!b&&a.model&&a.type&&(this._reverseRelations.push(a),this._addRelation(a.model,a),this.retroFitRelation(a))},addOrphanRelation:function(a){var b=c.any(this._orphanRelations,function(b){return c.all(a||[],function(a,c){return a===b[c]})});!b&&a.model&&a.type&&this._orphanRelations.push(a)},processOrphanRelations:function(){c.each(this._orphanRelations.slice(0),function(a){var d=b.Relational.store.getObjectByName(a.relatedModel);d&&(this.initializeRelation(null,a),this._orphanRelations=c.without(this._orphanRelations,a))},this)},_addRelation:function(a,b){a.prototype.relations||(a.prototype.relations=[]),a.prototype.relations.push(b),c.each(a._subModels||[],function(a){this._addRelation(a,b)},this)},retroFitRelation:function(a){var b=this.getCollection(a.model,!1);b&&b.each(function(b){if(b instanceof a.model){new a.type(b,a)}},this)},getCollection:function(a,d){a instanceof b.RelationalModel&&(a=a.constructor);for(var e=a;e._superModel;)e=e._superModel;var f=c.find(this._collections,function(a){return a.model===e});return f||d===!1||(f=this._createCollection(e)),f},getObjectByName:function(a){var b=a.split("."),d=null;return c.find(this._modelScopes,function(a){return d=c.reduce(b||[],function(a,b){return a?a[b]:void 0},a),d&&d!==a?!0:void 0},this),d},_createCollection:function(a){var c;return a instanceof b.RelationalModel&&(a=a.constructor),a.prototype instanceof b.RelationalModel&&(c=new b.Collection,c.model=a,this._collections.push(c)),c},resolveIdForItem:function(a,d){var e=c.isString(d)||c.isNumber(d)?d:null;return null===e&&(d instanceof b.RelationalModel?e=d.id:c.isObject(d)&&(e=d[a.prototype.idAttribute])),e||0===e||(e=null),e},find:function(a,b){var c=this.resolveIdForItem(a,b),d=this.getCollection(a);if(d){var e=d.get(c);if(e instanceof a)return e}return null},register:function(a){var b=this.getCollection(a);if(b){var c=a.collection;b.add(a),a.collection=c}},checkId:function(a,c){var d=this.getCollection(a),e=d&&d.get(c);if(e&&a!==e)throw b.Relational.showWarnings&&"undefined"!=typeof console&&console.warn("Duplicate id! Old RelationalModel=%o, new RelationalModel=%o",e,a),new Error("Cannot instantiate more than one Backbone.RelationalModel with the same id per type!")},update:function(a){var b=this.getCollection(a);b.contains(a)||this.register(a),b._onModelEvent("change:"+a.idAttribute,a,b),a.trigger("relational:change:id",a,b)},unregister:function(a){var d,e;a instanceof b.Model?(d=this.getCollection(a),e=[a]):a instanceof b.Collection?(d=this.getCollection(a.model),e=c.clone(a.models)):(d=this.getCollection(a),e=c.clone(d.models)),c.each(e,function(a){this.stopListening(a),c.invoke(a.getRelations(),"stopListening")},this),c.contains(this._collections,a)?d.reset([]):c.each(e,function(a){d.get(a)?d.remove(a):d.trigger("relational:remove",a,d)},this)},reset:function(){this.stopListening(),c.each(this._collections,function(a){this.unregister(a)},this),this._collections=[],this._subModels=[],this._modelScopes=[a]}}),b.Relational.store=new b.Store,b.Relation=function(a,d,e){if(this.instance=a,d=c.isObject(d)?d:{},this.reverseRelation=c.defaults(d.reverseRelation||{},this.options.reverseRelation),this.options=c.defaults(d,this.options,b.Relation.prototype.options),this.reverseRelation.type=c.isString(this.reverseRelation.type)?b[this.reverseRelation.type]||b.Relational.store.getObjectByName(this.reverseRelation.type):this.reverseRelation.type,this.key=this.options.key,this.keySource=this.options.keySource||this.key,this.keyDestination=this.options.keyDestination||this.keySource||this.key,this.model=this.options.model||this.instance.constructor,this.relatedModel=this.options.relatedModel,c.isUndefined(this.relatedModel)&&(this.relatedModel=this.model),!c.isFunction(this.relatedModel)||this.relatedModel.prototype instanceof b.RelationalModel||(this.relatedModel=c.result(this,"relatedModel")),c.isString(this.relatedModel)&&(this.relatedModel=b.Relational.store.getObjectByName(this.relatedModel)),this.checkPreconditions()&&(!this.options.isAutoRelation&&this.reverseRelation.type&&this.reverseRelation.key&&b.Relational.store.addReverseRelation(c.defaults({isAutoRelation:!0,model:this.relatedModel,relatedModel:this.model,reverseRelation:this.options},this.reverseRelation)),a)){var f=this.keySource;f!==this.key&&c.isObject(this.instance.get(this.key))&&(f=this.key),this.setKeyContents(this.instance.get(f)),this.relatedCollection=b.Relational.store.getCollection(this.relatedModel),this.keySource!==this.key&&delete this.instance.attributes[this.keySource],this.instance._relations[this.key]=this,this.initialize(e),this.options.autoFetch&&this.instance.getAsync(this.key,c.isObject(this.options.autoFetch)?this.options.autoFetch:{}),this.listenTo(this.instance,"destroy",this.destroy).listenTo(this.relatedCollection,"relational:add relational:change:id",this.tryAddRelated).listenTo(this.relatedCollection,"relational:remove",this.removeRelated)}},b.Relation.extend=b.Model.extend,c.extend(b.Relation.prototype,b.Events,b.Semaphore,{options:{createModels:!0,includeInJSON:!0,isAutoRelation:!1,autoFetch:!1,parse:!1},instance:null,key:null,keyContents:null,relatedModel:null,relatedCollection:null,reverseRelation:null,related:null,checkPreconditions:function(){var a=this.instance,d=this.key,e=this.model,f=this.relatedModel,g=b.Relational.showWarnings&&"undefined"!=typeof console;if(!e||!d||!f)return g&&console.warn("Relation=%o: missing model, key or relatedModel (%o, %o, %o).",this,e,d,f),!1;if(!(e.prototype instanceof b.RelationalModel))return g&&console.warn("Relation=%o: model does not inherit from Backbone.RelationalModel (%o).",this,a),!1;if(!(f.prototype instanceof b.RelationalModel))return g&&console.warn("Relation=%o: relatedModel does not inherit from Backbone.RelationalModel (%o).",this,f),!1;if(this instanceof b.HasMany&&this.reverseRelation.type===b.HasMany)return g&&console.warn("Relation=%o: relation is a HasMany, and the reverseRelation is HasMany as well.",this),!1;if(a&&c.keys(a._relations).length){var h=c.find(a._relations,function(a){return a.key===d},this);if(h)return g&&console.warn("Cannot create relation=%o on %o for model=%o: already taken by relation=%o.",this,d,a,h),!1}return!0},setRelated:function(a){this.related=a,this.instance.attributes[this.key]=a},_isReverseRelation:function(a){return a.instance instanceof this.relatedModel&&this.reverseRelation.key===a.key&&this.key===a.reverseRelation.key},getReverseRelations:function(a){for(var b=[],d=c.isUndefined(a)?this.related&&(this.related.models||[this.related]):[a],e=null,f=null,g=0;g<(d||[]).length;g++){e=d[g].getRelations()||[];for(var h=0;h<e.length;h++)f=e[h],this._isReverseRelation(f)&&b.push(f)}return b},destroy:function(){this.stopListening(),this instanceof b.HasOne?this.setRelated(null):this instanceof b.HasMany&&this.setRelated(this._prepareCollection()),c.each(this.getReverseRelations(),function(a){a.removeRelated(this.instance)},this)}}),b.HasOne=b.Relation.extend({options:{reverseRelation:{type:"HasMany"}},initialize:function(a){this.listenTo(this.instance,"relational:change:"+this.key,this.onChange);var b=this.findRelated(a);this.setRelated(b),c.each(this.getReverseRelations(),function(b){b.addRelated(this.instance,a)},this)},findRelated:function(a){var b=null;if(a=c.defaults({parse:this.options.parse},a),this.keyContents instanceof this.relatedModel)b=this.keyContents;else if(this.keyContents||0===this.keyContents){var d=c.defaults({create:this.options.createModels},a);b=this.relatedModel.findOrCreate(this.keyContents,d)}return b&&(this.keyId=null),b},setKeyContents:function(a){this.keyContents=a,this.keyId=b.Relational.store.resolveIdForItem(this.relatedModel,this.keyContents)},onChange:function(a,d,e){if(!this.isLocked()){this.acquire(),e=e?c.clone(e):{};var f=c.isUndefined(e.__related),g=f?this.related:e.__related;if(f){this.setKeyContents(d);var h=this.findRelated(e);this.setRelated(h)}if(g&&this.related!==g&&c.each(this.getReverseRelations(g),function(a){a.removeRelated(this.instance,null,e)},this),c.each(this.getReverseRelations(),function(a){a.addRelated(this.instance,e)},this),!e.silent&&this.related!==g){var i=this;this.changed=!0,b.Relational.eventQueue.add(function(){i.instance.trigger("change:"+i.key,i.instance,i.related,e,!0),i.changed=!1})}this.release()}},tryAddRelated:function(a,b,c){!this.keyId&&0!==this.keyId||a.id!==this.keyId||(this.addRelated(a,c),this.keyId=null)},addRelated:function(a,b){var d=this;a.queue(function(){if(a!==d.related){var e=d.related||null;d.setRelated(a),d.onChange(d.instance,a,c.defaults({__related:e},b))}})},removeRelated:function(a,b,d){if(this.related&&a===this.related){var e=this.related||null;this.setRelated(null),this.onChange(this.instance,a,c.defaults({__related:e},d))}}}),b.HasMany=b.Relation.extend({collectionType:null,options:{reverseRelation:{type:"HasOne"},collectionType:b.Collection,collectionKey:!0,collectionOptions:{}},initialize:function(a){if(this.listenTo(this.instance,"relational:change:"+this.key,this.onChange),this.collectionType=this.options.collectionType,!c.isFunction(this.collectionType)||this.collectionType===b.Collection||this.collectionType.prototype instanceof b.Collection||(this.collectionType=c.result(this,"collectionType")),c.isString(this.collectionType)&&(this.collectionType=b.Relational.store.getObjectByName(this.collectionType)),this.collectionType!==b.Collection&&!(this.collectionType.prototype instanceof b.Collection))throw new Error("`collectionType` must inherit from Backbone.Collection");var d=this.findRelated(a);this.setRelated(d)},_prepareCollection:function(a){if(this.related&&this.stopListening(this.related),!(a&&a instanceof b.Collection)){var d=c.isFunction(this.options.collectionOptions)?this.options.collectionOptions(this.instance):this.options.collectionOptions;a=new this.collectionType(null,d)}if(a.model=this.relatedModel,this.options.collectionKey){var e=this.options.collectionKey===!0?this.options.reverseRelation.key:this.options.collectionKey;a[e]&&a[e]!==this.instance?b.Relational.showWarnings&&"undefined"!=typeof console&&console.warn("Relation=%o; collectionKey=%s already exists on collection=%o",this,e,this.options.collectionKey):e&&(a[e]=this.instance)}return this.listenTo(a,"relational:add",this.handleAddition).listenTo(a,"relational:remove",this.handleRemoval).listenTo(a,"relational:reset",this.handleReset),a},findRelated:function(a){var d=null;
if(a=c.defaults({parse:this.options.parse},a),this.keyContents instanceof b.Collection)this._prepareCollection(this.keyContents),d=this.keyContents;else{var e=[];c.each(this.keyContents,function(b){var d=null;d=b instanceof this.relatedModel?b:this.relatedModel.findOrCreate(b,c.extend({merge:!0},a,{create:this.options.createModels})),d&&e.push(d)},this),d=this.related instanceof b.Collection?this.related:this._prepareCollection(),d.set(e,c.defaults({merge:!1,parse:!1},a))}return this.keyIds=c.difference(this.keyIds,c.pluck(d.models,"id")),d},setKeyContents:function(a){this.keyContents=a instanceof b.Collection?a:null,this.keyIds=[],this.keyContents||!a&&0!==a||(this.keyContents=c.isArray(a)?a:[a],c.each(this.keyContents,function(a){var c=b.Relational.store.resolveIdForItem(this.relatedModel,a);(c||0===c)&&this.keyIds.push(c)},this))},onChange:function(a,d,e){e=e?c.clone(e):{},this.setKeyContents(d),this.changed=!1;var f=this.findRelated(e);if(this.setRelated(f),!e.silent){var g=this;b.Relational.eventQueue.add(function(){g.changed&&(g.instance.trigger("change:"+g.key,g.instance,g.related,e,!0),g.changed=!1)})}},handleAddition:function(a,d,e){e=e?c.clone(e):{},this.changed=!0,c.each(this.getReverseRelations(a),function(a){a.addRelated(this.instance,e)},this);var f=this;!e.silent&&b.Relational.eventQueue.add(function(){f.instance.trigger("add:"+f.key,a,f.related,e)})},handleRemoval:function(a,d,e){e=e?c.clone(e):{},this.changed=!0,c.each(this.getReverseRelations(a),function(a){a.removeRelated(this.instance,null,e)},this);var f=this;!e.silent&&b.Relational.eventQueue.add(function(){f.instance.trigger("remove:"+f.key,a,f.related,e)})},handleReset:function(a,d){var e=this;d=d?c.clone(d):{},!d.silent&&b.Relational.eventQueue.add(function(){e.instance.trigger("reset:"+e.key,e.related,d)})},tryAddRelated:function(a,b,d){var e=c.contains(this.keyIds,a.id);e&&(this.addRelated(a,d),this.keyIds=c.without(this.keyIds,a.id))},addRelated:function(a,b){var d=this;a.queue(function(){d.related&&!d.related.get(a)&&d.related.add(a,c.defaults({parse:!1},b))})},removeRelated:function(a,b,c){this.related.get(a)&&this.related.remove(a,c)}}),b.RelationalModel=b.Model.extend({relations:null,_relations:null,_isInitialized:!1,_deferProcessing:!1,_queue:null,_attributeChangeFired:!1,subModelTypeAttribute:"type",subModelTypes:null,constructor:function(a,d){if(d&&d.collection){var e=this,f=this.collection=d.collection;delete d.collection,this._deferProcessing=!0;var g=function(a){a===e&&(e._deferProcessing=!1,e.processQueue(),f.off("relational:add",g))};f.on("relational:add",g),c.defer(function(){g(e)})}b.Relational.store.processOrphanRelations(),b.Relational.store.listenTo(this,"relational:unregister",b.Relational.store.unregister),this._queue=new b.BlockingQueue,this._queue.block(),b.Relational.eventQueue.block();try{b.Model.apply(this,arguments)}finally{b.Relational.eventQueue.unblock()}},trigger:function(a){if(a.length>5&&0===a.indexOf("change")){var c=this,d=arguments;b.Relational.eventQueue.isLocked()?b.Relational.eventQueue.add(function(){var e=!0;if("change"===a)e=c.hasChanged()||c._attributeChangeFired,c._attributeChangeFired=!1;else{var f=a.slice(7),g=c.getRelation(f);g?(e=d[4]===!0,e?c.changed[f]=d[2]:g.changed||delete c.changed[f]):e&&(c._attributeChangeFired=!0)}e&&b.Model.prototype.trigger.apply(c,d)}):b.Model.prototype.trigger.apply(c,d)}else"destroy"===a?(b.Model.prototype.trigger.apply(this,arguments),b.Relational.store.unregister(this)):b.Model.prototype.trigger.apply(this,arguments);return this},initializeRelations:function(a){this.acquire(),this._relations={},c.each(this.relations||[],function(c){b.Relational.store.initializeRelation(this,c,a)},this),this._isInitialized=!0,this.release(),this.processQueue()},updateRelations:function(a,b){this._isInitialized&&!this.isLocked()&&c.each(this._relations,function(c){if(!a||c.keySource in a||c.key in a){var d=this.attributes[c.keySource]||this.attributes[c.key],e=a&&(a[c.keySource]||a[c.key]);(c.related!==d||null===d&&null===e)&&this.trigger("relational:change:"+c.key,this,d,b||{})}c.keySource!==c.key&&delete this.attributes[c.keySource]},this)},queue:function(a){this._queue.add(a)},processQueue:function(){this._isInitialized&&!this._deferProcessing&&this._queue.isBlocked()&&this._queue.unblock()},getRelation:function(a){return this._relations[a]},getRelations:function(){return c.values(this._relations)},getIdsToFetch:function(a,d){var e=a instanceof b.Relation?a:this.getRelation(a),f=e?e.keyIds&&e.keyIds.slice(0)||(e.keyId||0===e.keyId?[e.keyId]:[]):[];if(d){var g=e.related&&(e.related.models||[e.related]);c.each(g,function(a){(a.id||0===a.id)&&f.push(a.id)})}return f},getAsync:function(a,d){d=c.extend({add:!0,remove:!1,refresh:!1},d);var e=this,f=[],g=this.getRelation(a),h=g&&this.getIdsToFetch(g,d.refresh),i=g.related instanceof b.Collection?g.related:g.relatedCollection;if(h&&h.length){var j,k=[],l=[],m=function(){k=c.map(h,function(a){var b=g.relatedModel.findModel(a);if(!b){var c={};c[g.relatedModel.prototype.idAttribute]=a,b=g.relatedModel.findOrCreate(c,d),l.push(b)}return b},this)};if(i instanceof b.Collection&&c.isFunction(i.url)){var n=i.url();j=i.url(h),j===n&&(m(),j=i.url(k),j===n&&(j=null))}if(j){var o=c.defaults({error:function(){c.each(l,function(a){a.trigger("destroy",a,a.collection,d)}),d.error&&d.error.apply(k,arguments)},url:j},d);f=[i.fetch(o)]}else k.length||m(),f=c.map(k,function(a){var b=c.defaults({error:function(){c.contains(l,a)&&a.trigger("destroy",a,a.collection,d),d.error&&d.error.apply(k,arguments)}},d);return a.fetch(b)},this)}return $.when.apply(null,f).then(function(){return b.Model.prototype.get.call(e,a)})},set:function(a,d,e){b.Relational.eventQueue.block();var f,g;c.isObject(a)||null==a?(f=a,e=d):(f={},f[a]=d);try{var h=this.id,i=f&&this.idAttribute in f&&f[this.idAttribute];b.Relational.store.checkId(this,i),g=b.Model.prototype.set.apply(this,arguments),this._isInitialized||this.isLocked()?i&&i!==h&&b.Relational.store.update(this):(this.constructor.initializeModelHierarchy(),(i||0===i)&&b.Relational.store.register(this),this.initializeRelations(e)),f&&this.updateRelations(f,e)}finally{b.Relational.eventQueue.unblock()}return g},clone:function(){var a=c.clone(this.attributes);return c.isUndefined(a[this.idAttribute])||(a[this.idAttribute]=null),c.each(this.getRelations(),function(b){delete a[b.key]}),new this.constructor(a)},toJSON:function(a){if(this.isLocked())return this.id;this.acquire();var d=b.Model.prototype.toJSON.call(this,a);return!this.constructor._superModel||this.constructor._subModelTypeAttribute in d||(d[this.constructor._subModelTypeAttribute]=this.constructor._subModelTypeValue),c.each(this._relations,function(e){var f=d[e.key],g=e.options.includeInJSON,h=null;g===!0?f&&c.isFunction(f.toJSON)&&(h=f.toJSON(a)):c.isString(g)?(f instanceof b.Collection?h=f.pluck(g):f instanceof b.Model&&(h=f.get(g)),g===e.relatedModel.prototype.idAttribute&&(e instanceof b.HasMany?h=h.concat(e.keyIds):e instanceof b.HasOne&&(h=h||e.keyId,h||c.isObject(e.keyContents)||(h=e.keyContents||null)))):c.isArray(g)?f instanceof b.Collection?(h=[],f.each(function(a){var b={};c.each(g,function(c){b[c]=a.get(c)}),h.push(b)})):f instanceof b.Model&&(h={},c.each(g,function(a){h[a]=f.get(a)})):delete d[e.key],null===h&&a&&a.wait&&(h=f),g&&(d[e.keyDestination]=h),e.keyDestination!==e.key&&delete d[e.key]}),this.release(),d}},{setup:function(){return this.prototype.relations=(this.prototype.relations||[]).slice(0),this._subModels={},this._superModel=null,this.prototype.hasOwnProperty("subModelTypes")?b.Relational.store.addSubModels(this.prototype.subModelTypes,this):this.prototype.subModelTypes=null,c.each(this.prototype.relations||[],function(a){if(a.model||(a.model=this),a.reverseRelation&&a.model===this){var d=!0;if(c.isString(a.relatedModel)){var e=b.Relational.store.getObjectByName(a.relatedModel);d=e&&e.prototype instanceof b.RelationalModel}d?b.Relational.store.initializeRelation(null,a):c.isString(a.relatedModel)&&b.Relational.store.addOrphanRelation(a)}},this),this},build:function(a,b){this.initializeModelHierarchy();var c=this._findSubModelType(this,a)||this;return new c(a,b)},_findSubModelType:function(a,b){if(a._subModels&&a.prototype.subModelTypeAttribute in b){var c=b[a.prototype.subModelTypeAttribute],d=a._subModels[c];if(d)return d;for(c in a._subModels)if(d=this._findSubModelType(a._subModels[c],b))return d}return null},initializeModelHierarchy:function(){if(this.inheritRelations(),this.prototype.subModelTypes){var a=c.keys(this._subModels),d=c.omit(this.prototype.subModelTypes,a);c.each(d,function(a){var c=b.Relational.store.getObjectByName(a);c&&c.initializeModelHierarchy()})}},inheritRelations:function(){if(c.isUndefined(this._superModel)||c.isNull(this._superModel))if(b.Relational.store.setupSuperModel(this),this._superModel){if(this._superModel.inheritRelations(),this._superModel.prototype.relations){var a=c.filter(this._superModel.prototype.relations||[],function(a){return!c.any(this.prototype.relations||[],function(b){return a.relatedModel===b.relatedModel&&a.key===b.key},this)},this);this.prototype.relations=a.concat(this.prototype.relations)}}else this._superModel=!1},findOrCreate:function(a,b){b||(b={});var d=c.isObject(a)&&b.parse&&this.prototype.parse?this.prototype.parse(c.clone(a)):a,e=this.findModel(d);return c.isObject(a)&&(e&&b.merge!==!1?(delete b.collection,delete b.url,e.set(d,b)):e||b.create===!1||(e=this.build(d,c.defaults({parse:!1},b)))),e},find:function(a,b){return b||(b={}),b.create=!1,this.findOrCreate(a,b)},findModel:function(a){return b.Relational.store.find(this,a)}}),c.extend(b.RelationalModel.prototype,b.Semaphore),b.Collection.prototype.__prepareModel=b.Collection.prototype._prepareModel,b.Collection.prototype._prepareModel=function(a,d){var e;return a instanceof b.Model?(a.collection||(a.collection=this),e=a):(d=d?c.clone(d):{},d.collection=this,e="undefined"!=typeof this.model.findOrCreate?this.model.findOrCreate(a,d):new this.model(a,d),e&&e.validationError&&(this.trigger("invalid",this,a,d),e=!1)),e};var d=b.Collection.prototype.__set=b.Collection.prototype.set;b.Collection.prototype.set=function(a,e){if(!(this.model.prototype instanceof b.RelationalModel))return d.call(this,a,e);e&&e.parse&&(a=this.parse(a,e));var f=!c.isArray(a),g=[],h=[],i=null;a=f?a?[a]:[]:c.clone(a);for(var j=0;j<a.length;j++)i=a[j],i instanceof b.Model||(i=b.Collection.prototype._prepareModel.call(this,i,e)),i&&(h.push(i),this.get(i)||this.get(i.cid)?null!==i.id&&void 0!==i.id&&(this._byId[i.id]=i):g.push(i));h=f?h.length?h[0]:null:h;var k=d.call(this,h,c.defaults({merge:!1,parse:!1},e));for(j=0;j<g.length;j++)i=g[j],(this.get(i)||this.get(i.cid))&&this.trigger("relational:add",i,this,e);return k};var e=b.Collection.prototype.__remove=b.Collection.prototype.remove;b.Collection.prototype.remove=function(a,d){if(!(this.model.prototype instanceof b.RelationalModel))return e.call(this,a,d);var f=!c.isArray(a),g=[];a=f?a?[a]:[]:c.clone(a),d||(d={}),c.each(a,function(a){a=this.get(a)||a&&this.get(a.cid),a&&g.push(a)},this);var h=e.call(this,f?g.length?g[0]:null:g,d);return c.each(g,function(a){this.trigger("relational:remove",a,this,d)},this),h};var f=b.Collection.prototype.__reset=b.Collection.prototype.reset;b.Collection.prototype.reset=function(a,d){d=c.extend({merge:!0},d);var e=f.call(this,a,d);return this.model.prototype instanceof b.RelationalModel&&this.trigger("relational:reset",this,d),e};var g=b.Collection.prototype.__sort=b.Collection.prototype.sort;b.Collection.prototype.sort=function(a){var c=g.call(this,a);return this.model.prototype instanceof b.RelationalModel&&this.trigger("relational:reset",this,a),c};var h=b.Collection.prototype.__trigger=b.Collection.prototype.trigger;b.Collection.prototype.trigger=function(a){if(!(this.model.prototype instanceof b.RelationalModel))return h.apply(this,arguments);if("add"===a||"remove"===a||"reset"===a||"sort"===a){var d=this,e=arguments;c.isObject(e[3])&&(e=c.toArray(e),e[3]=c.clone(e[3])),b.Relational.eventQueue.add(function(){h.apply(d,e)})}else h.apply(this,arguments);return this},b.RelationalModel.extend=function(a,c){var d=b.Model.extend.call(this,a,c);return d.setup(this),d}});